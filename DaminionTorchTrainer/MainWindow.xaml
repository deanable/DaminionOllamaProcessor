<Window x:Class="DaminionTorchTrainer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:DaminionTorchTrainer.Converters"
        Title="Daminion TorchSharp Trainer" Height="900" Width="1400"
        WindowStartupLocation="CenterScreen">
    
    <Window.Resources>
        <converters:EnumToBooleanConverter x:Key="EnumToBooleanConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#2196F3" Padding="15,10">
            <TextBlock Text="Daminion TorchSharp Trainer" 
                       FontSize="24" 
                       FontWeight="Bold" 
                       Foreground="White"/>
        </Border>

        <!-- Main Content - Tabbed Interface -->
        <TabControl Grid.Row="1" Margin="15">
            
            <!-- Data Source Tab -->
            <TabItem Header="Data Source">
                <ScrollViewer>
                    <StackPanel Margin="10">
                        <GroupBox Header="Data Source Selection" Margin="5">
                            <StackPanel Margin="5">
                                <RadioButton Content="Daminion API" 
                                             IsChecked="{Binding SelectedDataSource, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=API}"
                                             Margin="5"/>
                                <RadioButton Content="Local Images" 
                                             IsChecked="{Binding SelectedDataSource, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=Local}"
                                             Margin="5"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Daminion API Section -->
                        <GroupBox Header="Daminion Connection" Margin="5">
                            <StackPanel Margin="5">
                                <Label Content="URL:"/>
                                <TextBox Text="{Binding DaminionUrl}" Margin="5"/>
                                <Label Content="Username:"/>
                                <TextBox Text="{Binding DaminionUsername}" Margin="5"/>
                                <Label Content="Password:"/>
                                <PasswordBox x:Name="DaminionPasswordBox" 
                                            PasswordChanged="DaminionPasswordBox_PasswordChanged"
                                            Margin="5"/>
                                <StackPanel Orientation="Horizontal" Margin="5">
                                    <Button Content="Connect" 
                                            Command="{Binding ConnectCommand}" 
                                            Margin="5"/>
                                    <Button Content="Disconnect" 
                                            Command="{Binding DisconnectCommand}" 
                                            Margin="5"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                        <!-- API Data Extraction -->
                        <GroupBox Header="API Data Extraction" Margin="5">
                            <StackPanel Margin="5">
                                <Label Content="Max Items:"/>
                                <StackPanel Orientation="Horizontal" Margin="5">
                                    <Slider Value="{Binding MaxItems}" 
                                            Minimum="500" 
                                            Maximum="10000" 
                                            TickFrequency="500"
                                            TickPlacement="BottomRight"
                                            IsSnapToTickEnabled="True"
                                            Width="300"
                                            Margin="0,0,10,0"/>
                                    <TextBlock Text="{Binding MaxItems}" 
                                               VerticalAlignment="Center"
                                               MinWidth="60"
                                               FontWeight="Bold"/>
                                </StackPanel>
                                
                                <RadioButton Content="Search Query" 
                                             IsChecked="{Binding UseSearchQuery}" 
                                             Margin="5"/>
                                <TextBox Text="{Binding SearchQuery}" 
                                         Margin="5" 
                                         IsEnabled="{Binding UseSearchQuery}"
                                         ToolTip="Enter search terms to search across all metadata (filename, folder, title, description, categories, keywords, etc.). Uses Daminion's 'Everywhere' search (ID 5000)."/>
                                
                                <RadioButton Content="Collection" 
                                             IsChecked="{Binding UseCollection}" 
                                             Margin="5"/>
                                <StackPanel Orientation="Horizontal" Margin="5">
                                    <ComboBox ItemsSource="{Binding AvailableCollections}"
                                              SelectedItem="{Binding SelectedCollection}"
                                              DisplayMemberPath="Text"
                                              Width="300"
                                              IsEnabled="{Binding UseCollection}"/>
                                    <Button Content="Refresh Collections" 
                                            Command="{Binding RefreshCollectionsCommand}" 
                                            Margin="5,0,0,0"/>
                                </StackPanel>
                                <TextBlock Text="{Binding SelectedCollectionText}" 
                                           Margin="5" 
                                           Foreground="Gray"/>
                                
                                <Button Content="Extract Data" 
                                        Command="{Binding ExtractDataCommand}" 
                                        Margin="5"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Local Images Section -->
                        <GroupBox Header="Local Images" Margin="5">
                            <StackPanel Margin="5">
                                <Label Content="Image Folder:"/>
                                <StackPanel Orientation="Horizontal" Margin="5">
                                    <TextBox Text="{Binding LocalImageFolder}" 
                                             IsReadOnly="True"
                                             Width="400"
                                             Margin="0,0,5,0"/>
                                    <Button Content="Browse" 
                                            Command="{Binding BrowseFolderCommand}"/>
                                </StackPanel>
                                <CheckBox Content="Include Subfolders" 
                                          IsChecked="{Binding IncludeSubfolders}" 
                                          Margin="5"/>
                                <Button Content="Extract Data from Local Images" 
                                        Command="{Binding ExtractDataCommand}" 
                                        Margin="5"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Extraction Progress -->
                        <GroupBox Header="Extraction Progress" Margin="5">
                            <StackPanel Margin="5">
                                <ProgressBar Value="{Binding ExtractionProgress}" 
                                             Maximum="{Binding ExtractionTotal}" 
                                             Height="20" 
                                             Margin="5"/>
                                <TextBlock Text="{Binding ExtractionStatus}" 
                                           Margin="5"/>
                                <TextBlock Text="{Binding CurrentDataset.TotalSamples, StringFormat='Samples: {0}'}" 
                                           Margin="5" 
                                           FontWeight="Bold"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Data Management -->
                        <GroupBox Header="Data Management" Margin="5">
                            <StackPanel Margin="5">
                                <WrapPanel>
                                    <Button Content="Test Data Extraction" 
                                            Command="{Binding TestDataExtractionCommand}" 
                                            Margin="5"
                                            Background="LightBlue"
                                            Width="120"/>
                                    <Button Content="Save Dataset" 
                                            Command="{Binding SaveDatasetCommand}" 
                                            Margin="5"
                                            Background="LightGreen"
                                            Width="100"/>
                                    <Button Content="Export Properties" 
                                            Command="{Binding ExportPropertiesCommand}" 
                                            Margin="5"
                                            Background="LightYellow"
                                            Width="120"/>
                                    <Button Content="Load Dataset" 
                                            Command="{Binding LoadDatasetCommand}" 
                                            Margin="5"
                                            Width="100"/>
                                    <Button Content="Open Data Folder" 
                                            Command="{Binding OpenDataFolderCommand}" 
                                            Margin="5"
                                            Background="LightGray"
                                            Width="120"/>
                                </WrapPanel>
                                <TextBlock Text="Extracted datasets are saved as JSON files. Use 'Save Dataset' to export for reuse during development." 
                                           Margin="5" 
                                           TextWrapping="Wrap"
                                           FontStyle="Italic"/>
                                <TextBlock Text="{Binding DataManagementStatus}" 
                                           Margin="5" 
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Training Configuration Tab -->
            <TabItem Header="Training Configuration">
                <ScrollViewer>
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- TorchSharp Configuration -->
                        <StackPanel Grid.Column="0" Margin="5">
                            <GroupBox Header="TorchSharp Configuration" Margin="5">
                                <StackPanel Margin="5">
                                    <Label Content="Learning Rate:"/>
                                    <TextBox Text="{Binding TrainingConfig.LearningRate}" Margin="5"/>
                                    <Label Content="Epochs:"/>
                                    <TextBox Text="{Binding TrainingConfig.Epochs}" Margin="5"/>
                                    <Label Content="Batch Size:"/>
                                    <TextBox Text="{Binding TrainingConfig.BatchSize}" Margin="5"/>
                                    <Label Content="Device:"/>
                                    <ComboBox Text="{Binding TrainingConfig.Device}" Margin="5">
                                        <ComboBoxItem Content="CPU"/>
                                        <ComboBoxItem Content="CUDA"/>
                                        <ComboBoxItem Content="MPS"/>
                                    </ComboBox>
                                    <Label Content="Feature Dimension:"/>
                                    <TextBox Text="{Binding TrainingConfig.FeatureDimension}" Margin="5"/>
                                    <Label Content="Output Dimension:"/>
                                    <TextBox Text="{Binding TrainingConfig.OutputDimension}" Margin="5"/>
                                    <Label Content="Hidden Dimensions (comma-separated):"/>
                                    <StackPanel Orientation="Horizontal" Margin="5">
                                        <ComboBox ItemsSource="{Binding HiddenDimensionPresets}"
                                                  SelectedItem="{Binding SelectedHiddenDimensionPreset}"
                                                  Width="200"
                                                  Margin="0,0,5,0"/>
                                        <TextBox Text="{Binding TrainingConfig.HiddenDimensionsString}" 
                                                 Width="200"
                                                 ToolTip="Comma-separated list of hidden layer sizes (e.g., 256, 128, 64)"/>
                                    </StackPanel>
                                    <Label Content="Dropout Rate:"/>
                                    <TextBox Text="{Binding TrainingConfig.DropoutRate}" Margin="5"/>
                                    <Label Content="Weight Decay:"/>
                                    <TextBox Text="{Binding TrainingConfig.WeightDecay}" Margin="5"/>
                                    <Label Content="Validation Split:"/>
                                    <TextBox Text="{Binding TrainingConfig.ValidationSplit}" Margin="5"/>
                                    <CheckBox Content="Use Early Stopping" 
                                              IsChecked="{Binding TrainingConfig.UseEarlyStopping}" 
                                              Margin="5"/>
                                    <Label Content="Early Stopping Patience:"/>
                                    <TextBox Text="{Binding TrainingConfig.EarlyStoppingPatience}" Margin="5"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                        <!-- ML.NET Configuration -->
                        <StackPanel Grid.Column="1" Margin="5">
                            <GroupBox Header="ML.NET Configuration" Margin="5">
                                <StackPanel Margin="5">
                                    <Label Content="MBConfig File:"/>
                                    <StackPanel Orientation="Horizontal" Margin="5">
                                        <TextBox Text="{Binding MbConfigPath}" 
                                                 IsReadOnly="True"
                                                 Margin="0,0,5,0"/>
                                        <Button Content="Browse" 
                                                Command="{Binding BrowseMbConfigCommand}"/>
                                    </StackPanel>
                                    <Button Content="Load MBConfig" 
                                            Command="{Binding LoadMbConfigCommand}" 
                                            Margin="5"/>
                                    <TextBlock Text="{Binding MbConfigStatus}" 
                                               Margin="5" 
                                               TextWrapping="Wrap"/>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="Training Method" Margin="5">
                                <StackPanel Margin="5">
                                    <RadioButton Content="TorchSharp (Deep Learning)" 
                                                 IsChecked="{Binding UseTorchSharp}" 
                                                 Margin="5"/>
                                    <RadioButton Content="ML.NET (Traditional ML)" 
                                                 IsChecked="{Binding UseMLNet}" 
                                                 Margin="5"/>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="Training Controls" Margin="5">
                                <StackPanel Margin="5">
                                    <Button Content="Start Training" 
                                            Command="{Binding StartTrainingCommand}" 
                                            Margin="5"
                                            Background="LightGreen"/>
                                    <Button Content="Stop Training" 
                                            Command="{Binding StopTrainingCommand}" 
                                            Margin="5"
                                            Background="LightCoral"/>
                                    <CheckBox Content="Auto-export ONNX after training" 
                                              IsChecked="{Binding AutoExportOnnx}" 
                                              Margin="5"/>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="Configuration Management" Margin="5">
                                <StackPanel Margin="5">
                                    <Button Content="Save Configuration" 
                                            Command="{Binding SaveConfigCommand}" 
                                            Margin="5"/>
                                    <Button Content="Load Configuration" 
                                            Command="{Binding LoadConfigCommand}" 
                                            Margin="5"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- Training Progress Tab -->
            <TabItem Header="Training Progress">
                <ScrollViewer>
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Progress Display -->
                        <GroupBox Grid.Row="0" Header="Current Progress" Margin="5">
                            <StackPanel Margin="5">
                                <ProgressBar Value="{Binding CurrentProgress.CurrentEpoch}" 
                                             Maximum="{Binding CurrentProgress.TotalEpochs}" 
                                             Height="20" 
                                             Margin="5"/>
                                <TextBlock Text="{Binding CurrentProgress.Status}" 
                                           Margin="5" 
                                           FontWeight="Bold"/>
                                <Grid Margin="5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" 
                                               Text="{Binding CurrentProgress.CurrentEpoch, StringFormat='Epoch: {0}/{1}'}" 
                                               Margin="5"/>
                                    <TextBlock Grid.Column="1" 
                                               Text="{Binding CurrentProgress.TrainingLoss, StringFormat='Train Loss: {0:F4}'}" 
                                               Margin="5"/>
                                    <TextBlock Grid.Column="2" 
                                               Text="{Binding CurrentProgress.ValidationLoss, StringFormat='Val Loss: {0:F4}'}" 
                                               Margin="5"/>
                                    <TextBlock Grid.Column="3" 
                                               Text="{Binding CurrentProgress.ValidationAccuracy, StringFormat='Val Acc: {0:P2}'}" 
                                               Margin="5"/>
                                </Grid>
                            </StackPanel>
                        </GroupBox>

                        <!-- Training Logs -->
                        <GroupBox Grid.Row="1" Header="Training Logs" Margin="5">
                            <Grid Margin="5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <ListBox Grid.Row="0" 
                                         ItemsSource="{Binding TrainingLogs}" 
                                         Height="300"
                                         Margin="5"/>
                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="5">
                                    <Button Content="Clear Logs" 
                                            Command="{Binding ClearLogsCommand}" 
                                            Margin="5"/>
                                    <Button Content="Export Logs" 
                                            Command="{Binding ExportLogsCommand}" 
                                            Margin="5"/>
                                </StackPanel>
                            </Grid>
                        </GroupBox>

                        <!-- Export Controls -->
                        <GroupBox Grid.Row="2" Header="Export" Margin="5">
                            <StackPanel Margin="5">
                                <Button Content="Export ONNX Model" 
                                        Command="{Binding ExportOnnxCommand}" 
                                        Margin="5"/>
                                <Button Content="Open Export Folder" 
                                        Command="{Binding OpenExportFolderCommand}" 
                                        Margin="5"/>
                                <TextBlock Text="{Binding ExportStatus}" 
                                           Margin="5" 
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </GroupBox>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- Model Testing Tab -->
            <TabItem Header="Model Testing">
                <ScrollViewer>
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Model Selection -->
                        <StackPanel Grid.Column="0" Margin="5">
                            <GroupBox Header="Model Selection" Margin="5">
                                <StackPanel Margin="5">
                                    <Label Content="Select Model:"/>
                                    <ComboBox ItemsSource="{Binding AvailableModels}"
                                              SelectedItem="{Binding SelectedModel}"
                                              Margin="5"/>
                                    <Button Content="Refresh Models" 
                                            Command="{Binding RefreshModelsCommand}" 
                                            Margin="5"/>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="Image Selection" Margin="5">
                                <StackPanel Margin="5">
                                    <Label Content="Test Image:"/>
                                    <StackPanel Orientation="Horizontal" Margin="5">
                                        <TextBox Text="{Binding SelectedImagePath}" 
                                                 IsReadOnly="True"
                                                 Margin="0,0,5,0"/>
                                        <Button Content="Browse" 
                                                Command="{Binding BrowseImageCommand}"/>
                                    </StackPanel>
                                    <Image Source="{Binding ImagePreview}" 
                                           Height="200" 
                                           Margin="5"
                                           Stretch="Uniform"/>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="Test Settings" Margin="5">
                                <StackPanel Margin="5">
                                    <Label Content="Result Threshold (%):"/>
                                    <Slider Value="{Binding ResultThreshold}" 
                                            Minimum="0" 
                                            Maximum="100" 
                                            Margin="5"/>
                                    <TextBlock Text="{Binding ResultThreshold, StringFormat='Threshold: {0:F0}%'}" 
                                               Margin="5"/>
                                    <Button Content="Test Model" 
                                            Command="{Binding TestModelCommand}" 
                                            Margin="5"
                                            Background="LightBlue"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                        <!-- Test Results -->
                        <StackPanel Grid.Column="1" Margin="5">
                            <GroupBox Header="Test Results" Margin="5">
                                <StackPanel Margin="5">
                                    <TextBlock Text="{Binding TestStatus}" 
                                               Margin="5" 
                                               FontWeight="Bold"/>
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                                  HorizontalScrollBarVisibility="Auto"
                                                  MaxHeight="400">
                                        <ListBox ItemsSource="{Binding TestResults}" 
                                                 Margin="5">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" 
                                                               TextWrapping="Wrap"
                                                               Margin="2"/>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </ScrollViewer>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="#F5F5F5" BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
            <TextBlock Text="{Binding Status}" 
                       Margin="20,10" 
                       VerticalAlignment="Center"/>
        </Border>
    </Grid>
</Window>
